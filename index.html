<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover" />
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="theme-color" content="#0b0d12" />
<title>ManyMoney ‚Äî v5.8 (—á–∏—Å—Ç–∞—è —Å–±–æ—Ä–∫–∞)</title>
<style>
:root{
  --bg:#0b0d12; --card:#121621; --muted:#9aa3b2; --text:#f2f5fb; --accent:#67b7ff; --green:#36d07a; --red:#ff6b6b;
  --chip:#161b28; --chip-on:#2c3a5c; --border:#2a3143; --btn:#1d2537; --btn-hover:#283453; --chip-text:#dbe3f5; --chip-muted:#b8c2d8;
}
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0; background:var(--bg); color:var(--text); font:16px/1.4 system-ui,-apple-system,Segoe UI,Roboto,Arial}
.wrap{max-width:1040px; margin:0 auto; padding:16px; display:grid; gap:16px}

.toolbar{display:flex; justify-content:space-between; align-items:center; gap:8px}
.tabs{display:flex; gap:8px; flex-wrap:wrap}
.tab{padding:8px 12px; border-radius:10px; border:1px solid var(--border); background:var(--btn); color:var(--text); cursor:pointer}
.tab.active{background:var(--chip-on); border-color:var(--accent)}
.brand{color:var(--muted); font-size:14px}
.menu{display:flex; gap:8px; flex-wrap:wrap}

.top{display:grid; gap:12px; background:var(--card); padding:16px; border:1px solid var(--border); border-radius:16px}
.display{display:flex; align-items:center; justify-content:space-between; background:#0f1320; border:1px solid var(--border); border-radius:12px; padding:14px 16px}
.amount{font-size:28px; font-variant-numeric:tabular-nums; letter-spacing:0.5px}
.amount.expense{color:var(--red)}
.amount.income{color:var(--green)}
.type-toggle{display:flex; gap:8px}
.type-toggle button{padding:8px 12px; border-radius:10px; border:1px solid var(--border); background:var(--btn); color:var(--text); cursor:pointer}
.type-toggle button[aria-pressed="true"]{background:var(--chip-on); border-color:var(--accent)}

.keypad{display:grid; grid-template-columns:repeat(3,1fr); gap:10px}
.keypad button{background:var(--btn); border:1px solid var(--border); color:var(--text); font-size:20px; padding:16px 0; border-radius:12px; cursor:pointer}
.keypad button:hover{background:var(--btn-hover)}
.keypad .wide{grid-column: span 2}

.calendar-row{display:grid; gap:8px}
.calendar-inner{display:flex; gap:8px; align-items:center; flex-wrap:wrap}
.calendar-inner input, .calendar-inner select, .calendar-inner input[type="number"]{padding:10px 12px; border-radius:10px; border:1px solid var(--border); background:#0f1320; color:var(--text)}
.repeat-row{display:flex; gap:8px; align-items:center; flex-wrap:wrap}
.muted{color:var(--muted); font-size:12px}

.bottom{display:grid; gap:16px; background:var(--card); padding:16px; border:1px solid var(--border); border-radius:16px}
.row{display:grid; gap:10px}
.row .label{font-size:13px; color:var(--chip-muted)}
.chips{display:flex; gap:8px; flex-wrap:wrap}
.chip{position:relative; background:var(--chip); border:1px solid var(--border); padding:8px 28px 8px 10px; border-radius:999px; cursor:pointer; user-select:none; color:var(--chip-text)}
.chip[aria-pressed="true"], .chip.active{background:var(--chip-on); border-color:var(--accent); color:#fff}
.chip .del{position:absolute; right:4px; top:4px; width:18px; height:18px; border-radius:9px; border:1px solid var(--border); background:#0e1424; display:none; align-items:center; justify-content:center; font-size:12px; cursor:pointer; z-index:2}
.chip.delmode{padding-right:34px}
.chip.delmode .del{display:flex}
.addline{display:flex; gap:8px}
.addline input{flex:1; padding:10px 12px; border-radius:10px; border:1px solid var(--border); background:#0f1320; color:var(--text)}
.addline button{padding:10px 12px; border-radius:10px; border:1px solid var(--border); background:var(--btn); color:var(--text); cursor:pointer}
.addline button:hover{background:var(--btn-hover)}
.searchline{display:flex; gap:8px; align-items:center}
.searchline input{flex:1; padding:10px 12px; border-radius:10px; border:1px solid var(--border); background:#0f1320; color:var(--text)}
.row .controls{display:flex; gap:8px; align-items:center; flex-wrap:wrap}

.save{display:flex; gap:12px; align-items:center}
.save button{padding:12px 16px; border-radius:12px; border:1px solid var(--border); background:var(--accent); color:#08101a; font-weight:700; cursor:pointer}

.list{background:var(--card); padding:16px; border:1px solid var(--border); border-radius:16px}
table{width:100%; border-collapse:collapse}
th,td{border-bottom:1px solid var(--border); padding:10px; text-align:left; vertical-align:top}
th{color:var(--chip-muted); font-weight:600}
.badge{display:inline-block; padding:2px 8px; border-radius:999px; border:1px solid var(--border); background:#0f1320; font-size:12px; margin-right:6px}
.row-del{padding:6px 10px; border-radius:8px; border:1px solid var(--border); background:#1c2536; color:#dbe3f5; cursor:pointer}
.row-del:hover{background:#283453}

.stats{display:none; gap:16px; background:var(--card); padding:16px; border:1px solid var(--border); border-radius:16px}
.stats.show{display:grid}
.seg{display:flex; gap:8px; align-items:center; flex-wrap:wrap}
.seg .btn{padding:8px 12px; border-radius:10px; border:1px solid var(--border); background:var(--btn); color:var(--text); cursor:pointer}
.seg .btn[aria-pressed="true"]{background:var(--chip-on); border-color:var(--accent)}
.headline{font-size:20px}
.total{font-size:16px; color:var(--muted)}
.periodNav{display:flex; gap:8px; align-items:center}
.periodNav .arrow{padding:6px 10px; border-radius:8px; border:1px solid var(--border); background:var(--btn); cursor:pointer}
.chartRow{display:grid; grid-template-columns: 320px 1fr; gap:16px}
.legend table{width:100%; border-collapse:collapse}
.legend th,.legend td{border-bottom:1px solid var(--border); padding:8px; text-align:left}
.swatch{display:inline-block; width:12px; height:12px; border-radius:3px; margin-right:8px}

.analytics{display:none; gap:16px; background:var(--card); padding:16px; border:1px solid var(--border); border-radius:16px}
.analytics.show{display:grid}
.cards{display:grid; grid-template-columns:repeat(auto-fit,minmax(260px,1fr)); gap:12px}
.card{background:#0f1320; border:1px solid var(--border); border-radius:14px; padding:12px}
.card h3{margin:0 0 8px 0; font-size:16px}
.mini th,.mini td{border-bottom:1px solid var(--border); padding:6px; font-size:14px}
.flex{display:flex; gap:8px; align-items:center; flex-wrap:wrap}

@media (min-width:1000px){ .grid{display:grid; grid-template-columns:1fr 1fr; gap:16px} .top{grid-column:1/-1} }
input, select, textarea, button{ font-size:16px; -webkit-text-size-adjust:100%; touch-action:manipulation }
@media (max-width:480px){ .chartRow{ grid-template-columns:1fr } #donut{ width:100%; height:auto } }
</style>
</head>
<body>
<div class="wrap">
  <div class="toolbar">
    <div class="tabs">
      <button id="tabInput" class="tab active">–í–≤–æ–¥</button>
      <button id="tabStats" class="tab">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</button>
      <button id="tabAnalytics" class="tab">–ê–Ω–∞–ª–∏—Ç–∏–∫–∞</button>
    </div>
    <div class="menu">
      <button id="btnExport" class="tab">–≠–∫—Å–ø–æ—Ä—Ç .json</button>
      <button id="btnImport" class="tab">–ò–º–ø–æ—Ä—Ç</button>
      <button id="btnSettings" class="tab">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</button>
      <input id="importFile" type="file" accept="application/json" style="display:none" />
    </div>
    <div class="brand">ManyMoney v5.8</div>
  </div>

  <!-- INPUT VIEW -->
  <section class="top" id="viewInputTop" aria-label="–í–≤–æ–¥ —Å—É–º–º—ã">
    <div class="display">
      <div id="amount" class="amount expense">- 0</div>
      <div class="type-toggle" role="group" aria-label="–¢–∏–ø –æ–ø–µ—Ä–∞—Ü–∏–∏">
        <button id="btnExpense" aria-pressed="true">- —Ä–∞—Å—Ö–æ–¥</button>
        <button id="btnIncome" aria-pressed="false">+ –¥–æ—Ö–æ–¥</button>
      </div>
    </div>
    <div class="keypad" aria-label="–ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞">
      <button data-key="1">1</button><button data-key="2">2</button><button data-key="3">3</button>
      <button data-key="4">4</button><button data-key="5">5</button><button data-key="6">6</button>
      <button data-key="7">7</button><button data-key="8">8</button><button data-key="9">9</button>
      <button data-key=",">,</button><button data-key="0">0</button>
      <button data-action="back">‚å´</button>
      <button class="wide" data-action="clear">–°–±—Ä–æ—Å</button>
      <button class="wide" id="saveBtn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    </div>

    <div class="calendar-row">
      <div class="calendar-inner">
        <label for="opDate" class="muted" style="font-size:13px">–î–∞—Ç–∞ –æ–ø–µ—Ä–∞—Ü–∏–∏</label>
        <input id="opDate" type="date" />
        <span class="muted">–ï—Å–ª–∏ –ø—É—Å—Ç–æ - —Å–µ–≥–æ–¥–Ω—è</span>
      </div>
      <div class="repeat-row">
        <label class="muted" style="font-size:13px">–ü–æ–≤—Ç–æ—Ä—è—Ç—å</label>
        <select id="repeatKind">
          <option value="none">–ù–µ –ø–æ–≤—Ç–æ—Ä—è—Ç—å</option>
          <option value="weekly">–ù–µ–¥–µ–ª—è</option>
          <option value="monthly">–ú–µ—Å—è—Ü</option>
          <option value="yearly">–ì–æ–¥</option>
          <option value="ndays">N –¥–Ω–µ–π</option>
        </select>
        <input id="repeatEvery" type="number" min="2" value="7" title="–ö–∞–∂–¥—ã–µ N –¥–Ω–µ–π" style="width:140px; display:none" />
      </div>
    </div>
  </section>

  <section class="bottom" id="viewInputBottom">
    <div class="row">
      <div class="label">–ö–∞—Ç–µ–≥–æ—Ä–∏—è</div>
      <div class="controls">
        <div class="searchline"><input id="searchCategory" placeholder="–ü–æ–∏—Å–∫ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏" /></div>
        <button id="catDelMode" class="tab" aria-pressed="false">–£–¥–∞–ª–∏—Ç—å</button>
      </div>
      <div class="chips" id="categoryList"></div>
      <div class="addline">
        <input id="newCategory" placeholder="–ù–æ–≤–∞—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è" maxlength="30" />
        <button id="addCategory">–î–æ–±–∞–≤–∏—Ç—å</button>
      </div>
    </div>

    <div class="row">
      <div class="label">–•—ç—à—Ç–µ–≥–∏</div>
      <div class="controls">
        <div class="searchline"><input id="searchTag" placeholder="–ü–æ–∏—Å–∫ #—Ç–µ–≥–∞" /></div>
        <button id="tagDelMode" class="tab" aria-pressed="false">–£–¥–∞–ª–∏—Ç—å</button>
      </div>
      <div class="chips" id="tagList"></div>
      <div class="addline">
        <input id="newTag" placeholder="#—Ö—ç—à—Ç–µ–≥" maxlength="30" />
        <button id="addTag">–î–æ–±–∞–≤–∏—Ç—å</button>
      </div>
      <div class="muted">–£–¥–µ—Ä–∂–∏–≤–∞–π —á–∏–ø –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è –Ω–∞ –º–æ–±–∏–ª—å–Ω–æ–º</div>
    </div>

    <div class="save">
      <button id="saveBottom">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –æ–ø–µ—Ä–∞—Ü–∏—é</button>
      <div class="hint muted">Enter —Ç–æ–∂–µ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç</div>
    </div>
  </section>

  <section class="list" id="viewInputList">
    <div class="muted" style="margin-bottom:8px">–ù–∞–∂–º–∏ –ø–æ —Å—Ç—Ä–æ–∫–µ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è ‚Ä¢ –î–æ–ª–≥–æ–µ –Ω–∞–∂–∞—Ç–∏–µ/—Ä–µ–∂–∏–º ¬´–£–¥–∞–ª–∏—Ç—å¬ª ‚Äî —É–¥–∞–ª–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é/—Ç–µ–≥</div>
    <table>
      <thead><tr><th>–î–∞—Ç–∞</th><th>–°—É–º–º–∞</th><th>–ö–∞—Ç–µ–≥–æ—Ä–∏—è</th><th>–¢–µ–≥–∏</th><th></th></tr></thead>
      <tbody id="txTable"></tbody>
    </table>
  </section>

  <!-- STATS -->
  <section class="stats" id="viewStats">
    <div class="seg periodNav">
      <button class="arrow" id="prevPeriod">‚óÄ</button>
      <button class="btn" id="perDay" aria-pressed="false">–î–µ–Ω—å</button>
      <button class="btn" id="perMonth" aria-pressed="true">–ú–µ—Å—è—Ü</button>
      <button class="btn" id="perYear" aria-pressed="false">–ì–æ–¥</button>
      <span class="headline" id="periodTitle" style="margin-left:8px"></span>
      <button class="arrow" id="nextPeriod">‚ñ∂</button>
    </div>
    <div class="seg">
      <button class="btn" id="statExpense" aria-pressed="true">–†–∞—Å—Ö–æ–¥—ã</button>
      <button class="btn" id="statIncome" aria-pressed="false">–î–æ—Ö–æ–¥—ã</button>
      <span class="total" id="totalLabel"></span>
    </div>
    <div class="seg">
      <span class="muted">–ì—Ä—É–ø–ø–∏—Ä–æ–≤–∞—Ç—å –ø–æ:</span>
      <button class="btn" id="groupByCat" aria-pressed="true">–ö–∞—Ç–µ–≥–æ—Ä–∏–∏</button>
      <button class="btn" id="groupByTag" aria-pressed="false">–•—ç—à—Ç–µ–≥–∏</button>
    </div>
    <div class="chartRow">
      <svg id="donut" viewBox="0 0 200 200" width="300" height="300" aria-label="–î–∏–∞–≥—Ä–∞–º–º–∞"></svg>
      <div class="legend">
        <table>
          <thead><tr><th>–ì—Ä—É–ø–ø–∞</th><th>%</th><th>–°—É–º–º–∞</th></tr></thead>
          <tbody id="legendBody"></tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- ANALYTICS -->
  <section class="analytics" id="viewAnalytics">
    <div class="seg periodNav">
      <button class="arrow" id="aPrev">‚óÄ</button>
      <button class="btn" id="aDay" aria-pressed="false">–î–µ–Ω—å</button>
      <button class="btn" id="aMonth" aria-pressed="true">–ú–µ—Å—è—Ü</button>
      <button class="btn" id="aYear" aria-pressed="false">–ì–æ–¥</button>
      <span class="headline" id="aTitle" style="margin-left:8px"></span>
      <button class="arrow" id="aNext">‚ñ∂</button>
    </div>
    <div class="cards">
      <div class="card"><h3>–¢–æ–ø-—Ç–µ–≥–∏</h3><table class="mini"><tbody id="topTags"></tbody></table></div>
      <div class="card"><h3>–ü–∞—Ä–Ω—ã–µ —Ç–µ–≥–∏</h3><table class="mini"><tbody id="pairs"></tbody></table></div>
      <div class="card"><h3>–ï—Å–ª–∏ —Å–æ–∫—Ä–∞—Ç–∏—Ç—å —Ç–µ–≥</h3>
        <div class="flex">
          <select id="whatIfTag"></select>
          <input id="whatIfPct" type="range" min="10" max="90" step="10" value="30" />
          <span id="whatIfOut" class="muted"></span>
        </div>
      </div>
      <div class="card"><h3>–¢—Ä–µ–Ω–¥ –ø–æ –¥–Ω—è–º</h3><canvas id="trend" width="520" height="140"></canvas></div>
    </div>
  </section>
</div>

<!-- Settings modal -->
<div id="settingsModal" class="modal" aria-hidden="true" role="dialog" style="position:fixed; inset:0; display:none; align-items:center; justify-content:center">
  <div id="stBackdrop" style="position:absolute; inset:0; background:rgba(0,0,0,.5)"></div>
  <div style="position:relative; background:var(--card); border:1px solid var(--border); border-radius:16px; width:min(560px,94vw); padding:16px; display:grid; gap:12px">
    <h3 style="margin:0 0 8px 0">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h3>
    <label style="display:flex; align-items:center; gap:8px">
      <input id="soundToggle" type="checkbox" /> –ó–≤—É–∫ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏
    </label>
    <div style="display:flex; gap:8px; justify-content:flex-end; margin-top:8px">
      <button id="stClose" class="tab">–ó–∞–∫—Ä—ã—Ç—å</button>
    </div>
  </div>
</div>

<!-- Editor -->
<div id="editorModal" class="modal" aria-hidden="true" role="dialog" style="position:fixed; inset:0; display:none; align-items:center; justify-content:center;">
  <div id="editorBackdrop" style="position:absolute; inset:0; background:rgba(0,0,0,.5)"></div>
  <div style="position:relative; background:var(--card); border:1px solid var(--border); border-radius:16px; width:min(560px,94vw); padding:16px; display:grid; gap:12px">
    <header style="font-weight:700">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –æ–ø–µ—Ä–∞—Ü–∏—é</header>
    <div style="display:grid; grid-template-columns:1fr auto; gap:8px; align-items:center">
      <label>–°—É–º–º–∞</label>
      <div class="type-toggle">
        <button id="edExpense">- —Ä–∞—Å—Ö–æ–¥</button>
        <button id="edIncome">+ –¥–æ—Ö–æ–¥</button>
      </div>
    </div>
    <input id="edAmount" type="text" inputmode="decimal" placeholder="0" style="padding:10px 12px; border-radius:10px; border:1px solid var(--border); background:#0f1320; color:var(--text)" />
    <label>–î–∞—Ç–∞ –∏ –≤—Ä–µ–º—è</label>
    <input id="edDate" type="datetime-local" style="padding:10px 12px; border-radius:10px; border:1px solid var(--border); background:#0f1320; color:var(--text)" />
    <label>–ö–∞—Ç–µ–≥–æ—Ä–∏—è</label>
    <div class="chips" id="edCategories"></div>
    <label>–•—ç—à—Ç–µ–≥–∏</label>
    <div class="chips" id="edTags"></div>
    <div style="display:flex; gap:8px; justify-content:flex-end">
      <button id="edCancel" class="tab">–û—Ç–º–µ–Ω–∞</button>
      <button id="edSave" class="tab" style="background:var(--accent); color:#08101a; font-weight:700">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    </div>
  </div>
</div>

<div id="dbg" style="display:none; position:fixed; bottom:8px; left:8px; background:#512; color:#fff; padding:6px 8px; border-radius:6px; font:12px/1.2 system-ui; z-index:9999"></div>

<script>
const VIEW={INPUT:'input', STATS:'stats', ANALYTICS:'analytics'};
const LS={cat_exp:'categories_expense', cat_inc:'categories_income', tag_exp:'tags_expense', tag_inc:'tags_income', tx:'tx', settings:'settings', recur:'recur'};
function $id(id){return document.getElementById(id)}
function load(k,d){try{return JSON.parse(localStorage.getItem(k))??d}catch{return d}}
function save(k,v){localStorage.setItem(k,JSON.stringify(v))}
function dbg(msg,err){const d=$id('dbg'); d.style.display='block'; d.textContent='[ManyMoney] '+msg+(err?': '+(err.message||err):''); console.error('[ManyMoney]',msg,err||'')}
window.addEventListener('error',e=>dbg('JS',e.error||e.message))
window.addEventListener('unhandledrejection',e=>dbg('Promise',e.reason||e))

// migrate
;(function(){
  const oc=load('categories',null), ot=load('tags',null);
  if(oc){ if(!localStorage.getItem(LS.cat_exp)) save(LS.cat_exp,oc); if(!localStorage.getItem(LS.cat_inc)) save(LS.cat_inc,oc); localStorage.removeItem('categories'); }
  if(ot){ if(!localStorage.getItem(LS.tag_exp)) save(LS.tag_exp,ot); if(!localStorage.getItem(LS.tag_inc)) save(LS.tag_inc,ot); localStorage.removeItem('tags'); }
})();

const S={
  type:'expense', amountStr:'',
  dict:{
    expense:{categories:load(LS.cat_exp,['–µ–¥–∞','—Ç–∞–∫—Å–∏','–∞–≤—Ç–æ','–¥–æ–º','—Ä–∞–∑–≤–ª–µ—á–µ–Ω–∏—è']), tags:load(LS.tag_exp,['–∏–º–ø—É–ª—å—Å–∏–≤–Ω–æ','–¥–ª—è_—Ä–µ–±–µ–Ω–∫–∞','–∞–ª–∫–æ–≥–æ–ª—å','–Ω–µ_—Å–¥–µ–ª–∞–ª_–≤–æ–≤—Ä–µ–º—è'])},
    income:{categories:load(LS.cat_inc,['–∑–∞—Ä–ø–ª–∞—Ç–∞','–ø–æ–¥—Ä–∞–±–æ—Ç–∫–∞','–ø–æ–¥–∞—Ä–æ–∫']), tags:load(LS.tag_inc,['–ø—Ä–µ–º–∏—è','–∞–≤–∞–Ω—Å'])}
  },
  selectedCategory:null, selectedTags:new Set(),
  tx:load(LS.tx,[]),
  recur:load(LS.recur,[]),
  settings:load(LS.settings,{sound:true}),
  view:VIEW.INPUT,
  statPeriod:'month', statType:'expense', statCursor:new Date().toISOString(), groupMode:'cat',
  aPeriod:'month', aCursor:new Date().toISOString(),
  opDate:'', delMode:{cat:false, tag:false}
};

// nav
const tabInput=$id('tabInput'), tabStats=$id('tabStats'), tabAnalytics=$id('tabAnalytics');
const viewStats=$id('viewStats'), viewInputTop=$id('viewInputTop'), viewInputBottom=$id('viewInputBottom'), viewInputList=$id('viewInputList'), viewAnalytics=$id('viewAnalytics');
function setView(v){
  S.view=v;
  tabInput.classList.toggle('active', v===VIEW.INPUT);
  tabStats.classList.toggle('active', v===VIEW.STATS);
  tabAnalytics.classList.toggle('active', v===VIEW.ANALYTICS);
  viewStats.classList.toggle('show', v===VIEW.STATS);
  viewAnalytics.classList.toggle('show', v===VIEW.ANALYTICS);
  viewInputTop.style.display = v===VIEW.INPUT?'grid':'none';
  viewInputBottom.style.display = v===VIEW.INPUT?'grid':'none';
  viewInputList.style.display = v===VIEW.INPUT?'block':'none';
  if(v===VIEW.STATS) renderStats();
  if(v===VIEW.ANALYTICS) renderAnalytics();
}
tabInput.onclick=()=>setView(VIEW.INPUT);
tabStats.onclick=()=>setView(VIEW.STATS);
tabAnalytics.onclick=()=>setView(VIEW.ANALYTICS);

// amount & keypad & repeat
const amountEl=$id('amount'), keypad=document.querySelector('.keypad'), btnExpense=$id('btnExpense'), btnIncome=$id('btnIncome'), opDate=$id('opDate');
const repeatKind=$id('repeatKind'), repeatEvery=$id('repeatEvery');
repeatKind.onchange=()=>{ repeatEvery.style.display = repeatKind.value==='ndays' ? '' : 'none'; };
opDate.onchange=()=>{ S.opDate=opDate.value; };
function renderAmount(){ const sign=S.type==='expense'?'-':'+'; const val=S.amountStr.replace(/^\./,'0.'); amountEl.textContent=`${sign} ${val.length?val:'0'}`; amountEl.classList.toggle('expense',S.type==='expense'); amountEl.classList.toggle('income',S.type==='income'); sortListsByAmount(); }
function setType(t){ S.type=t; btnExpense.setAttribute('aria-pressed',t==='expense'); btnIncome.setAttribute('aria-pressed',t==='income'); renderAmount(); renderCategories(); renderTags(); }
btnExpense.onclick=()=>setType('expense');
btnIncome.onclick=()=>setType('income');
keypad.addEventListener('click',e=>{
  const k=e.target.getAttribute('data-key'); const a=e.target.getAttribute('data-action');
  if(k){ if(k===',' && !S.amountStr.includes('.')) S.amountStr+='.'; else if(k!==',') S.amountStr+=k; }
  if(a==='back') S.amountStr=S.amountStr.slice(0,-1);
  if(a==='clear') S.amountStr='';
  renderAmount();
});
document.addEventListener('keydown',e=>{
  if(S.view!==VIEW.INPUT) return;
  if(/^[0-9]$/.test(e.key)){ S.amountStr+=e.key; renderAmount(); }
  if(e.key===','||e.key==='.'){ if(!S.amountStr.includes('.')){ S.amountStr+='.'; renderAmount(); } }
  if(e.key==='Backspace'){ S.amountStr=S.amountStr.slice(0,-1); renderAmount(); }
  if(e.key==='Escape'){ S.amountStr=''; renderAmount(); }
  if(e.key==='Enter'){ saveTx(); }
  if(e.key==='+'||e.key==='=') setType('income');
  if(e.key==='-') setType('expense');
});

// —ç–≤—Ä–∏—Å—Ç–∏–∫–∞ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ –ø–æ —Å—É–º–º–µ
const BINS=[0,300,1000,3000,Infinity];
function binFor(v){const n=Math.abs(Number(v)); for(let i=0;i<BINS.length-1;i++) if(n>=BINS[i]&&n<BINS[i+1]) return i; return 0;}
function usageMaps(){ const cat=new Map(), tag=new Map(); S.tx.forEach(r=>{ const typ=r.amount<0?'expense':'income'; if(typ!==S.type) return; if(r.category) cat.set(r.category,(cat.get(r.category)||0)+1); (r.tags||[]).forEach(t=> tag.set(t,(tag.get(t)||0)+1)); }); return {cat,tag}; }
function summedUsage(){ const byCat=new Map(), byTag=new Map(); S.tx.forEach(r=>{ const typ=r.amount<0?'expense':'income'; if(typ!==S.type) return; const b=binFor(r.amount); if(r.category){const a=byCat.get(r.category)||[0,0,0,0]; a[b]++; byCat.set(r.category,a);} (r.tags||[]).forEach(t=>{const a=byTag.get(t)||[0,0,0,0]; a[b]++; byTag.set(t,a);}); }); return {byCat,byTag}; }
function currentBin(){ const n=parseFloat(S.amountStr.replace(',','.')); return isFinite(n)?binFor(n):null; }
let cachedSortedCats=null, cachedSortedTags=null;
function sortListsByAmount(){ cachedSortedCats=null; cachedSortedTags=null; renderCategories(); renderTags(); }

// chips
const categoryList=$id('categoryList'), tagList=$id('tagList'), searchCategory=$id('searchCategory'), searchTag=$id('searchTag'), catDelModeBtn=$id('catDelMode'), tagDelModeBtn=$id('tagDelMode');
function makeChip(text, pressed, onToggle, onDelete){
  const b=document.createElement('button'); b.className='chip'; b.setAttribute('aria-pressed',!!pressed); b.appendChild(document.createTextNode(text));
  const del=document.createElement('span'); del.className='del'; del.textContent='√ó';
  del.onclick=(ev)=>{ ev.stopPropagation(); onDelete&&onDelete(); };
  b.appendChild(del);
  b.onclick=()=>{ const now=b.getAttribute('aria-pressed')!=="true"; b.setAttribute('aria-pressed',now); onToggle&&onToggle(now); };
  let tId=null; b.addEventListener('touchstart',()=>{ tId=setTimeout(()=>{ onDelete&&onDelete(); },600) },{passive:true}); b.addEventListener('touchend',()=>{ if(tId){ clearTimeout(tId); tId=null; } });
  b.oncontextmenu=(ev)=>{ ev.preventDefault(); onDelete&&onDelete(); };
  return b;
}
function saveDict(){ save(LS.cat_exp,S.dict.expense.categories); save(LS.cat_inc,S.dict.income.categories); save(LS.tag_exp,S.dict.expense.tags); save(LS.tag_inc,S.dict.income.tags); }
function currentLists(){ return S.dict[S.type] }

function renderCategories(){
  const q=(searchCategory.value||'').toLowerCase(); const {cat}=usageMaps(); const {byCat}=summedUsage(); const b=currentBin(); const list=currentLists().categories;
  if(!cachedSortedCats){ cachedSortedCats=[...list].sort((a,bn)=>{ const scA=b!=null?(byCat.get(a)?.[b]||0):0, scB=b!=null?(byCat.get(bn)?.[b]||0):0; const ocA=(cat.get(a)||0), ocB=(cat.get(bn)||0); return (scB-scA)||(ocB-ocA)||a.localeCompare(bn,'ru'); }); }
  categoryList.innerHTML='';
  cachedSortedCats.filter(n=>n.toLowerCase().includes(q)).forEach(name=>{
    const chip=makeChip(name, S.selectedCategory===name,
      on=>{ if(on){S.selectedCategory=name;} else if(S.selectedCategory===name){S.selectedCategory=null;} [...categoryList.children].forEach(c=> c.setAttribute('aria-pressed', c.textContent.replace('√ó','').trim()===S.selectedCategory)); },
      ()=>{ if(confirm(`–£–¥–∞–ª–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é "${name}"? –ó–∞–ø–∏—Å–∏ —Å–æ—Ö—Ä–∞–Ω—è—Ç—Å—è –∫–∞–∫ ¬´–ë–µ–∑ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏¬ª.`)){ currentLists().categories=list.filter(x=>x!==name); if(S.selectedCategory===name) S.selectedCategory=null; S.tx.forEach(t=>{ if(t.category===name) t.category=null; }); save(LS.tx,S.tx); saveDict(); cachedSortedCats=null; renderCategories(); renderTable(); } }
    );
    if(S.delMode.cat) chip.classList.add('delmode');
    categoryList.appendChild(chip);
  });
}
function renderTags(){
  const q=(searchTag.value||'').toLowerCase(); const {tag}=usageMaps(); const {byTag}=summedUsage(); const b=currentBin(); const list=currentLists().tags;
  if(!cachedSortedTags){ cachedSortedTags=[...list].sort((a,bn)=>{ const scA=b!=null?(byTag.get(a)?.[b]||0):0, scB=b!=null?(byTag.get(bn)?.[b]||0):0; const ocA=(tag.get(a)||0), ocB=(tag.get(bn)||0); return (scB-scA)||(ocB-ocA)||a.localeCompare(bn,'ru'); }); }
  tagList.innerHTML='';
  cachedSortedTags.filter(n=>('#'+n).toLowerCase().includes(q)||n.toLowerCase().includes(q)).forEach(name=>{
    const chip=makeChip('#'+name, S.selectedTags.has(name),
      on=>{ if(on) S.selectedTags.add(name); else S.selectedTags.delete(name); },
      ()=>{ if(confirm(`–£–¥–∞–ª–∏—Ç—å —Ç–µ–≥ #${name}? –û–Ω –±—É–¥–µ—Ç —É–¥–∞–ª–µ–Ω –∏–∑ –≤—Å–µ—Ö –∑–∞–ø–∏—Å–µ–π.`)){ currentLists().tags=list.filter(x=>x!==name); S.tx.forEach(t=>{ t.tags=(t.tags||[]).filter(x=>x!==name); }); save(LS.tx,S.tx); saveDict(); cachedSortedTags=null; renderTags(); renderTable(); } }
    );
    if(S.delMode.tag) chip.classList.add('delmode');
    tagList.appendChild(chip);
  });
}
catDelModeBtn.onclick=()=>{ S.delMode.cat=!S.delMode.cat; catDelModeBtn.setAttribute('aria-pressed',S.delMode.cat); renderCategories(); };
tagDelModeBtn.onclick=()=>{ S.delMode.tag=!S.delMode.tag; tagDelModeBtn.setAttribute('aria-pressed',S.delMode.tag); renderTags(); };
$id('addCategory').onclick=()=>{ const i=$id('newCategory'); const v=i.value.trim(); if(v){ const list=currentLists().categories; if(!list.includes(v)) list.push(v); saveDict(); cachedSortedCats=null; renderCategories(); i.value=''; i.focus(); } };
$id('addTag').onclick=()=>{ const i=$id('newTag'); const v=i.value.trim().replace(/^#/,''); if(v){ const list=currentLists().tags; if(!list.includes(v)) list.push(v); saveDict(); cachedSortedTags=null; renderTags(); i.value=''; i.focus(); } };
searchCategory.oninput=renderCategories; searchTag.oninput=renderTags;

// —ç–∫—Å–ø–æ—Ä—Ç/–∏–º–ø–æ—Ä—Ç
$id('btnExport').onclick=()=>{
  const payload={version:'5.8', exportedAt:new Date().toISOString(), data:{ dict:S.dict, tx:S.tx, settings:S.settings, recur:S.recur }};
  const blob=new Blob([JSON.stringify(payload,null,2)], {type:'application/json'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=`ManyMoney-${new Date().toISOString().slice(0,10)}.json`; a.click(); URL.revokeObjectURL(a.href);
};
const importInput=$id('importFile');
$id('btnImport').onclick=()=>importInput.click();
importInput.onchange=async e=>{
  const f=e.target.files?.[0]; if(!f) return; if(!confirm('–ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ?')) return;
  try{
    const obj=JSON.parse(await f.text());
    const {dict,tx,settings,recur}=obj.data||{};
    ['expense','income'].forEach(t=>['categories','tags'].forEach(k=>{
      (dict?.[t]?.[k]||[]).forEach(v=>{ const dst=S.dict[t][k]; if(!dst.includes(v)) dst.push(v); });
    }));
    const byId=new Map(S.tx.map(x=>[x.id,x])); (tx||[]).forEach(r=>byId.set(r.id,r));
    S.tx=[...byId.values()].sort((a,b)=>new Date(b.at)-new Date(a.at));
    if(Array.isArray(recur)){ const ids=new Set(S.recur.map(r=>r.rid)); recur.forEach(tpl=>{ if(!ids.has(tpl.rid)) S.recur.push(tpl); }); }
    if(settings) S.settings.sound=!!settings.sound;
    save(LS.tx,S.tx); save(LS.recur,S.recur); save(LS.settings,S.settings); saveDict();
    cachedSortedCats=cachedSortedTags=null; renderCategories(); renderTags(); renderTable(); alert('–ò–º–ø–æ—Ä—Ç –∑–∞–≤–µ—Ä—à—ë–Ω');
  }catch(err){ alert('–û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞: '+(err.message||err)); }
  finally{ importInput.value=''; }
};

// –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ + –∑–≤—É–∫
const stModal=$id('settingsModal'), stBackdrop=$id('stBackdrop'), stClose=$id('stClose'), soundToggle=$id('soundToggle');
$id('btnSettings').onclick=()=>{ soundToggle.checked=!!S.settings.sound; stModal.style.display='flex'; };
stBackdrop.onclick=()=> stModal.style.display='none';
stClose.onclick=()=>{ S.settings.sound=!!soundToggle.checked; save(LS.settings,S.settings); stModal.style.display='none'; };
function playClick(){ if(!S.settings.sound) return; try{ const C=window.AudioContext||window.webkitAudioContext; if(C){ const ctx=playClick._ctx||(playClick._ctx=new C()); const o=ctx.createOscillator(), g=ctx.createGain(); o.type='sine'; o.frequency.setValueAtTime(880,ctx.currentTime); g.gain.setValueAtTime(0.06,ctx.currentTime); o.connect(g); g.connect(ctx.destination); o.start(); o.stop(ctx.currentTime+0.09); return; } }catch(e){} }

// —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ/–ø–æ–≤—Ç–æ—Ä—ã
const saveBtn=$id('saveBtn'), saveBottom=$id('saveBottom'), txTable=$id('txTable');
function parseAmount(){ if(!S.amountStr) return 0; const n=Number(S.amountStr); if(Number.isNaN(n)) return 0; return S.type==='expense'?-Math.abs(n):Math.abs(n); }
function buildAtFromDate(){ if(!S.opDate) return new Date().toISOString(); const now=new Date(); const [y,m,d]=S.opDate.split('-').map(Number); const local=new Date(y,(m-1),d, now.getHours(), now.getMinutes(), now.getSeconds()); return new Date(local.getTime()-local.getTimezoneOffset()*60000).toISOString(); }

function nextDate(dt,rule){ const d=new Date(dt); if(rule.kind==='weekly') d.setDate(d.getDate()+7*(rule.every||1)); else if(rule.kind==='monthly') d.setMonth(d.getMonth()+(rule.every||1)); else if(rule.kind==='yearly') d.setFullYear(d.getFullYear()+(rule.every||1)); else if(rule.kind==='ndays') d.setDate(d.getDate()+(rule.every||7)); return d; }
function idForOccur(tpl, at){ return `${tpl.rid}:${at.toISOString().slice(0,10)}`; }
function hasTxId(id){ return S.tx.some(x=>x.id===id); }
function generateDueOccurrences(templates, persist){ const now=new Date(); templates.forEach(tpl=>{ let cur=new Date(tpl.startAt); while(cur.getTime()<=now.getTime()+500){ const id=idForOccur(tpl, cur); if(!hasTxId(id)){ const row={id, at:cur.toISOString(), amount:tpl.amount, category:tpl.category, tags:tpl.tags, planned:false}; if(persist) S.tx.push(row); } cur=nextDate(cur, tpl.rule); } }); S.tx.sort((a,b)=>new Date(b.at)-new Date(a.at)); if(persist) save(LS.tx,S.tx); }
function materializeInPeriod(templates,start,end){ const out=[]; templates.forEach(tpl=>{ let cur=new Date(tpl.startAt); while(cur.getTime()<end.getTime()){ if(cur.getTime()>=start.getTime()){ const id=idForOccur(tpl,cur); if(!hasTxId(id)) out.push({id, at:cur.toISOString(), amount:tpl.amount, category:tpl.category, tags:tpl.tags, planned:cur.getTime()>Date.now()+500}); } cur=nextDate(cur,tpl.rule); } }); return out; }

function saveTx(){
  const amt=parseAmount(); if(!amt){ amountEl.style.outline='2px solid var(--accent)'; setTimeout(()=>amountEl.style.outline='none',300); return; }
  const category=S.selectedCategory||null; const tags=Array.from(S.selectedTags);
  const baseAt=new Date(buildAtFromDate());
  const kind=repeatKind.value, everyN=Math.max(2, Number(repeatEvery.value)||7);
  const rows=[];
  function push(atDate){ const iso=atDate.toISOString(); const isFuture=atDate.getTime()>Date.now()+1000; rows.push({id:crypto.randomUUID(), at:iso, amount:amt, category, tags, planned:isFuture}); }
  if(kind==='none'){ push(baseAt); }
  else{
    const tpl={ rid:crypto.randomUUID(), startAt:baseAt.toISOString(), amount:amt, type:(amt<0?'expense':'income'), category, tags,
      rule:(kind==='weekly')?{kind:'weekly',every:1}:(kind==='monthly')?{kind:'monthly',every:1}:(kind==='yearly')?{kind:'yearly',every:1}:{kind:'ndays',every:everyN} };
    S.recur.push(tpl); save(LS.recur,S.recur); generateDueOccurrences([tpl], true);
  }
  if(rows.length) S.tx.unshift(...rows);
  save(LS.tx,S.tx);
  S.amountStr=''; S.selectedTags.clear(); renderAmount(); renderTags(); renderTable(); playClick();
}
saveBtn.onclick=saveTx; saveBottom.onclick=saveTx;

function renderTable(){
  generateDueOccurrences(S.recur, true);
  txTable.innerHTML='';
  S.tx.slice(0,100).forEach(r=>{
    const tr=document.createElement('tr');
    const td1=document.createElement('td'); td1.textContent=new Date(r.at).toLocaleString();
    const td2=document.createElement('td'); td2.style.whiteSpace='nowrap'; td2.style.color=r.amount<0?'var(--red)':'var(--green)'; td2.textContent=(r.amount<0?'':'+')+r.amount.toLocaleString(undefined,{maximumFractionDigits:2});
    const td3=document.createElement('td'); if(r.category){ const b=document.createElement('span'); b.className='badge'; b.textContent=r.category; td3.appendChild(b);} else { const m=document.createElement('span'); m.className='muted'; m.textContent='‚Äî'; td3.appendChild(m); }
    const td4=document.createElement('td'); if(r.tags&&r.tags.length){ r.tags.forEach(t=>{ const b=document.createElement('span'); b.className='badge'; b.textContent='#'+t; td4.appendChild(b); }); } else { const m=document.createElement('span'); m.className='muted'; m.textContent='‚Äî'; td4.appendChild(m); }
    const td5=document.createElement('td'); td5.style.textAlign='right'; const del=document.createElement('button'); del.className='row-del'; del.title='–£–¥–∞–ª–∏—Ç—å'; del.textContent='üóë'; del.onclick=(ev)=>{ ev.stopPropagation(); if(confirm('–£–¥–∞–ª–∏—Ç—å –∑–∞–ø–∏—Å—å?')){ const i=S.tx.findIndex(x=>x.id===r.id); if(i>-1){ S.tx.splice(i,1); save(LS.tx,S.tx); renderTable(); } } }; td5.appendChild(del);
    tr.append(td1,td2,td3,td4,td5);
    tr.style.cursor='pointer'; tr.title='–ù–∞–∂–º–∏, —á—Ç–æ–±—ã —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å';
    tr.onclick=()=>openEditor(r.id);
    txTable.appendChild(tr);
  });
}

// editor
const modal=$id('editorModal'), edAmount=$id('edAmount'), edDate=$id('edDate'), edCats=$id('edCategories'), edTags=$id('edTags'), edBtnSave=$id('edSave'), edBtnCancel=$id('edCancel'), edExpense=$id('edExpense'), edIncome=$id('edIncome');
const E={id:null,type:'expense',amountStr:'',at:new Date().toISOString(),category:null,tags:new Set()};
function toInputDT(iso){ const d=new Date(iso); const off=d.getTimezoneOffset(); const local=new Date(d.getTime()-off*60000); return local.toISOString().slice(0,16); }
function fromInputDT(str){ const d=new Date(str); const off=d.getTimezoneOffset(); const utc=new Date(d.getTime()+off*60000); return utc.toISOString(); }
function renderEdCats(){ edCats.innerHTML=''; const list=S.dict[E.type].categories; list.forEach(name=>{ const b=document.createElement('button'); b.className='chip'; b.textContent=name; b.setAttribute('aria-pressed',E.category===name); b.onclick=()=>{ E.category=(E.category===name?null:name); renderEdCats(); }; edCats.appendChild(b); }); }
function renderEdTags(){ edTags.innerHTML=''; const list=S.dict[E.type].tags; list.forEach(t=>{ const b=document.createElement('button'); b.className='chip'; b.textContent='#'+t; const on=E.tags.has(t); b.setAttribute('aria-pressed',on); b.onclick=()=>{ on?E.tags.delete(t):E.tags.add(t); renderEdTags(); }; edTags.appendChild(b); }); }
function setEdType(t){ E.type=t; renderEdCats(); renderEdTags(); }
function openEditor(id){ const row=S.tx.find(x=>x.id===id); if(!row) return; E.id=id; E.type=row.amount<0?'expense':'income'; E.amountStr=Math.abs(row.amount).toString(); E.at=row.at; E.category=row.category||null; E.tags=new Set(row.tags||[]); edAmount.value=E.amountStr; edDate.value=toInputDT(E.at); setEdType(E.type); modal.style.display='flex'; }
function closeEditor(){ modal.style.display='none'; }
$id('editorBackdrop').onclick=closeEditor; edBtnCancel.onclick=closeEditor;
edExpense.onclick=()=>setEdType('expense'); edIncome.onclick=()=>setEdType('income');
edBtnSave.onclick=()=>{ const n=parseFloat(edAmount.value.replace(',','.'))||0; if(!n){ edAmount.focus(); return; } const row=S.tx.find(x=>x.id===E.id); if(!row) return; row.amount=(E.type==='expense'?-Math.abs(n):Math.abs(n)); row.at=fromInputDT(edDate.value||new Date().toISOString()); row.category=E.category||null; row.tags=Array.from(E.tags); row.planned = new Date(row.at).getTime()>Date.now()+1000; save(LS.tx,S.tx); renderTable(); closeEditor(); };

// stats
const perDay=$id('perDay'), perMonth=$id('perMonth'), perYear=$id('perYear'), statExpense=$id('statExpense'), statIncome=$id('statIncome'), periodTitle=$id('periodTitle'), totalLabel=$id('totalLabel'), donut=$id('donut'), legendBody=$id('legendBody'), groupByCat=$id('groupByCat'), groupByTagBtn=$id('groupByTag'); 
$id('prevPeriod').onclick=()=>shiftPeriod(-1); $id('nextPeriod').onclick=()=>shiftPeriod(1);
perDay.onclick=()=>setPeriod('day'); perMonth.onclick=()=>setPeriod('month'); perYear.onclick=()=>setPeriod('year');
statExpense.onclick=()=>setStatType('expense'); statIncome.onclick=()=>setStatType('income');
groupByCat.onclick=()=>{ S.groupMode='cat'; groupByCat.setAttribute('aria-pressed','true'); groupByTagBtn.setAttribute('aria-pressed','false'); renderStats(); };
groupByTagBtn.onclick=()=>{ S.groupMode='tag'; groupByCat.setAttribute('aria-pressed','false'); groupByTagBtn.setAttribute('aria-pressed','true'); renderStats(); };
function setPeriod(p){ S.statPeriod=p; perDay.setAttribute('aria-pressed',p==='day'); perMonth.setAttribute('aria-pressed',p==='month'); perYear.setAttribute('aria-pressed',p==='year'); renderStats(); }
function setStatType(t){ S.statType=t; statExpense.setAttribute('aria-pressed',t==='expense'); statIncome.setAttribute('aria-pressed',t==='income'); renderStats(); }
function rangeFrom(cursorISO,mode){ const d=new Date(cursorISO); if(mode==='day'){ const s=new Date(d.getFullYear(),d.getMonth(),d.getDate()); const e=new Date(s); e.setDate(e.getDate()+1); return {start:s,end:e,title:s.toLocaleDateString('ru-RU')}; } if(mode==='month'){ const s=new Date(d.getFullYear(),d.getMonth(),1); const e=new Date(d.getFullYear(),d.getMonth()+1,1); const title=s.toLocaleDateString('ru-RU',{month:'long',year:'numeric'}); return {start:s,end:e,title:title.charAt(0).toUpperCase()+title.slice(1)}; } const s=new Date(d.getFullYear(),0,1); const e=new Date(d.getFullYear()+1,0,1); return {start:s,end:e,title:d.getFullYear().toString()}; }
function shiftPeriod(dir){ const d=new Date(S.statCursor); if(S.statPeriod==='day') d.setDate(d.getDate()+dir); else if(S.statPeriod==='month') d.setMonth(d.getMonth()+dir); else d.setFullYear(d.getFullYear()+dir); S.statCursor=d.toISOString(); renderStats(); }
function filteredTx(){ const {start,end}=rangeFrom(S.statCursor,S.statPeriod); const persisted=S.tx.filter(r=>{ const t=new Date(r.at).getTime(); if(t<start.getTime()||t>=end.getTime()) return false; return S.statType==='expense'? r.amount<0 : r.amount>0; }); const virtual=materializeInPeriod(S.recur,start,end).filter(r=>S.statType==='expense'? r.amount<0 : r.amount>0); return persisted.concat(virtual); }
function groupRows(rows){ if(S.groupMode==='cat'){ const map=new Map(); rows.forEach(r=>{ const k=r.category||'–ë–µ–∑ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏'; map.set(k,(map.get(k)||0)+Math.abs(r.amount)); }); return Array.from(map.entries()).map(([name,sum])=>({name,sum})).sort((a,b)=>b.sum-a.sum); } const map=new Map(); rows.forEach(r=>{ (r.tags||['–ë–µ–∑ —Ç–µ–≥–∞']).forEach(t=>{ const k=t==='–ë–µ–∑ —Ç–µ–≥–∞'?'–ë–µ–∑ —Ç–µ–≥–æ–≤':'#'+t; map.set(k,(map.get(k)||0)+Math.abs(r.amount)); }); }); return Array.from(map.entries()).map(([name,sum])=>({name,sum})).sort((a,b)=>b.sum-a.sum); }
function polar(cx,cy,r,a){ const rad=a*Math.PI/180; return {x:cx+r*Math.cos(rad), y:cy+r*Math.sin(rad)} }
function palette(i){ const c=['#6bb1ff','#b388ff','#ff9f6e','#6ee7b7','#f87171','#fbbf24','#60a5fa','#c084fc','#8dd3c7','#80b1d3']; return c[i%c.length]; }
function renderDonut(data){ donut.innerHTML=''; const total=data.reduce((s,x)=>s+x.sum,0); const cx=100,cy=100,r=80,stroke=32; if(total<=0){ donut.innerHTML='<text x="100" y="105" text-anchor="middle" fill="#9aa3b2">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</text>'; return; } let start=-90; data.forEach((it,i)=>{ const frac=it.sum/total; const ang=Math.max(frac*360,0.5); const end=start+ang; const large=ang>180?1:0; const a=polar(cx,cy,r,start), b=polar(cx,cy,r,end); const path=`M ${a.x} ${a.y} A ${r} ${r} 0 ${large} 1 ${b.x} ${b.y}`; const arc=document.createElementNS('http://www.w3.org/2000/svg','path'); arc.setAttribute('d',path); arc.setAttribute('fill','none'); arc.setAttribute('stroke',palette(i)); arc.setAttribute('stroke-width',stroke); donut.appendChild(arc); start=end; }); const hole=document.createElementNS('http://www.w3.org/2000/svg','circle'); hole.setAttribute('cx',cx); hole.setAttribute('cy',cy); hole.setAttribute('r',r-stroke/2-1); hole.setAttribute('fill','#0b0d12'); donut.appendChild(hole); const t1=document.createElementNS('http://www.w3.org/2000/svg','text'); t1.setAttribute('x','100'); t1.setAttribute('y','96'); t1.setAttribute('text-anchor','middle'); t1.setAttribute('fill','#dbe3f5'); t1.textContent='–ò—Ç–æ–≥–æ'; const t2=document.createElementNS('http://www.w3.org/2000/svg','text'); t2.setAttribute('x','100'); t2.setAttribute('y','118'); t2.setAttribute('text-anchor','middle'); t2.setAttribute('fill','#ffffff'); t2.textContent=total.toLocaleString('ru-RU'); donut.appendChild(t1); donut.appendChild(t2); }
function renderStats(){ const rows=filteredTx(); const groups=groupRows(rows); const total=rows.reduce((s,x)=>s+Math.abs(x.amount),0); const {title}=rangeFrom(S.statCursor,S.statPeriod); periodTitle.textContent=title; totalLabel.textContent=(S.statType==='expense'?'–í—Å–µ–≥–æ –ø–æ—Ç—Ä–∞—á–µ–Ω–æ: ':'–í—Å–µ–≥–æ –∑–∞—Ä–∞–±–æ—Ç–∞–Ω–æ: ')+total.toLocaleString('ru-RU'); renderDonut(groups); legendBody.innerHTML=''; groups.forEach((g,i)=>{ const pct= total? Math.round(g.sum*100/total):0; const tr=document.createElement('tr'); tr.innerHTML=`<td><span class="swatch" style="background:${palette(i)}"></span>${g.name}</td><td>${pct}%</td><td>${g.sum.toLocaleString('ru-RU')}</td>`; legendBody.appendChild(tr); }); if(groups.length===0){ legendBody.innerHTML='<tr><td class="muted" colspan="3">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –∑–∞ –ø–µ—Ä–∏–æ–¥</td></tr>'; } }

// analytics (–∫–æ—Ä–æ—Ç–∫–æ ‚Äî –∫–∞–∫ –±—ã–ª–æ)
const aDay=$id('aDay'), aMonth=$id('aMonth'), aYear=$id('aYear'), aTitle=$id('aTitle');
$id('aPrev').onclick=()=>shiftAnalytic(-1);
$id('aNext').onclick=()=>shiftAnalytic(1);
aDay.onclick=()=>{ S.aPeriod='day'; setAButtons(); renderAnalytics(); };
aMonth.onclick=()=>{ S.aPeriod='month'; setAButtons(); renderAnalytics(); };
aYear.onclick=()=>{ S.aPeriod='year'; setAButtons(); renderAnalytics(); };
function setAButtons(){ aDay.setAttribute('aria-pressed',S.aPeriod==='day'); aMonth.setAttribute('aria-pressed',S.aPeriod==='month'); aYear.setAttribute('aria-pressed',S.aPeriod==='year'); }
function aRange(){ return rangeFrom(S.aCursor,S.aPeriod); }
function shiftAnalytic(dir){ const d=new Date(S.aCursor); if(S.aPeriod==='day') d.setDate(d.getDate()+dir); else if(S.aPeriod==='month') d.setMonth(d.getMonth()+dir); else d.setFullYear(d.getFullYear()+dir); S.aCursor=d.toISOString(); renderAnalytics(); }
function rowsInA(){ const {start,end}=aRange(); return S.tx.filter(r=>{ const t=new Date(r.at).getTime(); return t>=start.getTime() && t<end.getTime() && r.amount<0; }); }
function groupByTag(rows){ const m=new Map(); rows.forEach(r=>{ (r.tags||[]).forEach(t=> m.set(t,(m.get(t)||0)+Math.abs(r.amount)) ); }); return Array.from(m.entries()).map(([name,sum])=>({name,sum})).sort((a,b)=>b.sum-a.sum); }
function pairsFromTags(rows){ const cnt=new Map(); rows.forEach(r=>{ const arr=[...(r.tags||[])].sort(); for(let i=0;i<arr.length;i++){ for(let j=i+1;j<arr.length;j++){ const k=arr[i]+' + '+arr[j]; cnt.set(k,(cnt.get(k)||0)+Math.abs(r.amount)); } } }); return Array.from(cnt.entries()).map(([name,sum])=>({name,sum})).sort((a,b)=>b.sum-a.sum).slice(0,10); }
function renderAnalytics(){ const {title}=aRange(); aTitle.textContent=title; const rows=rowsInA(); const tagGroups=groupByTag(rows).slice(0,10); const total=rows.reduce((s,x)=>s+Math.abs(x.amount),0); const body1=$id('topTags'); body1.innerHTML=''; tagGroups.forEach(g=>{ const pct= total? Math.round(g.sum*100/total):0; const tr=document.createElement('tr'); tr.innerHTML=`<td>#${g.name}</td><td style="text-align:right">${pct}% ‚Ä¢ ${g.sum.toLocaleString('ru-RU')}</td>`; body1.appendChild(tr); }); if(tagGroups.length===0){ body1.innerHTML='<tr><td class="muted">–ù–µ—Ç —Ç–µ–≥–æ–≤</td></tr>'; } const body2=$id('pairs'); body2.innerHTML=''; const prs=pairsFromTags(rows); prs.forEach(p=>{ const tr=document.createElement('tr'); tr.innerHTML=`<td>${p.name}</td><td style="text-align:right">${p.sum.toLocaleString('ru-RU')}</td>`; body2.appendChild(tr); }); if(prs.length===0){ body2.innerHTML='<tr><td class="muted">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</td></tr>'; } const sel=$id('whatIfTag'); sel.innerHTML=''; groupByTag(S.tx.filter(x=>x.amount<0)).forEach(g=>{ const o=document.createElement('option'); o.value=g.name; o.textContent='#'+g.name; sel.appendChild(o); }); const pct=$id('whatIfPct'); const out=$id('whatIfOut'); function updateWI(){ const tag=sel.value; const sum=(groupByTag(rows).find(x=>x.name===tag)||{sum:0}).sum; const saveAmt=Math.round(sum*(Number(pct.value)/100)); out.textContent=`–≠–∫–æ–Ω–æ–º–∏—è: ${saveAmt.toLocaleString('ru-RU')}`; } sel.onchange=updateWI; pct.oninput=updateWI; updateWI(); drawTrend($id('trend'), rows); }
function drawTrend(cv,rows){ const ctx=cv.getContext('2d'); ctx.clearRect(0,0,cv.width,cv.height); const by=new Map(); rows.forEach(r=>{ const d=new Date(r.at); const k=new Date(d.getFullYear(),d.getMonth(),d.getDate()).toISOString(); by.set(k,(by.get(k)||0)+Math.abs(r.amount)); }); const keys=[...by.keys()].sort(); if(!keys.length){ ctx.fillStyle='#9aa3b2'; ctx.fillText('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö',10,20); return; } const vals=keys.map(k=>by.get(k)); const max=Math.max(...vals); const pad=20, w=cv.width-2*pad, h=cv.height-2*pad; ctx.strokeStyle='#67b7ff'; ctx.lineWidth=2; ctx.beginPath(); keys.forEach((k,i)=>{ const x=pad+i*(w/Math.max(1,keys.length-1)); const y=pad+h-(vals[i]/max)*h; if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y); }); ctx.stroke(); }

// init
renderAmount(); renderCategories(); renderTags(); renderTable(); setView(VIEW.INPUT);
</script>
</body>
</html>
